<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="utf-8">
<!--[if IE]><meta http-equiv="X-UA-Compatible" content="IE=edge"><![endif]-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 1.5.5.dev">
<meta name="author" content="Cloud-DI Team - Departamento de Informática. UAL">
<title>Docker. Una nueva forma de ejecutar y desarrollar aplicaciones</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | http://asciidoctor.org */
/* Remove comment around @import statement below when using as a custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section,summary{display:block}
audio,canvas,video{display:inline-block}
audio:not([controls]){display:none;height:0}
[hidden],template{display:none}
script{display:none!important}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
body{margin:0}
a{background:transparent}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
input[type="search"]{-webkit-appearance:textfield;-moz-box-sizing:content-box;-webkit-box-sizing:content-box;box-sizing:content-box}
input[type="search"]::-webkit-search-cancel-button,input[type="search"]::-webkit-search-decoration{-webkit-appearance:none}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*:before,*:after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
body{-webkit-font-smoothing:antialiased}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.center{margin-left:auto;margin-right:auto}
.spread{width:100%}
p.lead,.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{font-size:1.21875em;line-height:1.6}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0;direction:ltr}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:none}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #ddddd8;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol,ul.no-bullet,ol.no-bullet{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ul.no-bullet{list-style:none}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite:before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media only screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede}
table thead,table tfoot{background:#f7f8f7;font-weight:bold}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt,table tr:nth-of-type(even){background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{display:table-cell;line-height:1.6}
body{tab-size:4}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.clearfix:before,.clearfix:after,.float-group:before,.float-group:after{content:" ";display:table}
.clearfix:after,.float-group:after{clear:both}
*:not(pre)>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background-color:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre,pre>code{line-height:1.45;color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;text-rendering:optimizeSpeed}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background-color:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menu{color:rgba(0,0,0,.8)}
b.button:before,b.button:after{position:relative;top:-1px;font-weight:400}
b.button:before{content:"[";padding:0 3px 0 2px}
b.button:after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header:before,#header:after,#content:before,#content:after,#footnotes:before,#footnotes:after,#footer:before,#footer:after{content:" ";display:table}
#header:after,#content:after,#footnotes:after,#footer:after{clear:both}
#content{margin-top:1.25em}
#content:before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #ddddd8}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #ddddd8;padding-bottom:8px}
#header .details{border-bottom:1px solid #ddddd8;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span:before{content:"\00a0\2013\00a0"}
#header .details br+span.author:before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark:before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber:after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #ddddd8;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #efefed;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media only screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background-color:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #efefed;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #efefed;left:auto;right:0}}
@media only screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:100%;background-color:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
.sect1{padding-bottom:.625em}
@media only screen and (min-width:768px){.sect1{padding-bottom:1.25em}}
.sect1+.sect1{border-top:1px solid #efefed}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor:before,h2>a.anchor:before,h3>a.anchor:before,#toctitle>a.anchor:before,.sidebarblock>.content>.title>a.anchor:before,h4>a.anchor:before,h5>a.anchor:before,h6>a.anchor:before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock>caption.title{white-space:nowrap;overflow:visible;max-width:0}
.paragraph.lead>p,#preamble>.sectionbody>.paragraph:first-of-type p{color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>.paragraph:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #ddddd8;color:rgba(0,0,0,.6)}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock pre:not(.highlight),.listingblock pre[class="highlight"],.listingblock pre[class^="highlight "],.listingblock pre.CodeRay,.listingblock pre.prettyprint{background:#f7f7f8}
.sidebarblock .literalblock pre,.sidebarblock .listingblock pre:not(.highlight),.sidebarblock .listingblock pre[class="highlight"],.sidebarblock .listingblock pre[class^="highlight "],.sidebarblock .listingblock pre.CodeRay,.sidebarblock .listingblock pre.prettyprint{background:#f2f1f1}
.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{-webkit-border-radius:4px;border-radius:4px;word-wrap:break-word;padding:1em;font-size:.8125em}
.literalblock pre.nowrap,.literalblock pre[class].nowrap,.listingblock pre.nowrap,.listingblock pre[class].nowrap{overflow-x:auto;white-space:pre;word-wrap:normal}
@media only screen and (min-width:768px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:.90625em}}
@media only screen and (min-width:1280px){.literalblock pre,.literalblock pre[class],.listingblock pre,.listingblock pre[class]{font-size:1em}}
.literalblock.output pre{color:#f7f7f8;background-color:rgba(0,0,0,.9)}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.listingblock>.content{position:relative}
.listingblock code[data-lang]:before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:#999}
.listingblock:hover code[data-lang]:before{display:block}
.listingblock.terminal pre .command:before{content:attr(data-prompt);padding-right:.5em;color:#999}
.listingblock.terminal pre .command:not([data-prompt]):before{content:"$"}
table.pyhltable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.pyhltable td{vertical-align:top;padding-top:0;padding-bottom:0;line-height:1.45}
table.pyhltable td.code{padding-left:.75em;padding-right:0}
pre.pygments .lineno,table.pyhltable td:not(.code){color:#999;padding-left:0;padding-right:.5em;border-right:1px solid #ddddd8}
pre.pygments .lineno{display:inline-block;margin-right:.25em}
table.pyhltable .linenodiv{background:none!important;padding-right:0!important}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock blockquote p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote:before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.5em;margin-right:.5ex;text-align:right}
.quoteblock .quoteblock{margin-left:0;margin-right:0;padding:.5em 0;border-left:3px solid rgba(0,0,0,.6)}
.quoteblock .quoteblock blockquote{padding:0 0 0 .75em}
.quoteblock .quoteblock blockquote:before{display:none}
.verseblock{margin:0 1em 1.25em 1em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract{margin:0 0 1.25em 0;display:block}
.quoteblock.abstract blockquote,.quoteblock.abstract blockquote p{text-align:left;word-spacing:0}
.quoteblock.abstract blockquote:before,.quoteblock.abstract blockquote p:first-of-type:before{display:none}
table.tableblock{max-width:100%;border-collapse:separate}
table.tableblock td>.paragraph:last-child p>p:last-child,table.tableblock th>p:last-child,table.tableblock td>p:last-child{margin-bottom:0}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all th.tableblock,table.grid-all td.tableblock{border-width:0 1px 1px 0}
table.grid-all tfoot>tr>th.tableblock,table.grid-all tfoot>tr>td.tableblock{border-width:1px 1px 0 0}
table.grid-cols th.tableblock,table.grid-cols td.tableblock{border-width:0 1px 0 0}
table.grid-all *>tr>.tableblock:last-child,table.grid-cols *>tr>.tableblock:last-child{border-right-width:0}
table.grid-rows th.tableblock,table.grid-rows td.tableblock{border-width:0 0 1px 0}
table.grid-all tbody>tr:last-child>th.tableblock,table.grid-all tbody>tr:last-child>td.tableblock,table.grid-all thead:last-child>tr>th.tableblock,table.grid-rows tbody>tr:last-child>th.tableblock,table.grid-rows tbody>tr:last-child>td.tableblock,table.grid-rows thead:last-child>tr>th.tableblock{border-bottom-width:0}
table.grid-rows tfoot>tr>th.tableblock,table.grid-rows tfoot>tr>td.tableblock{border-width:1px 0 0 0}
table.frame-all{border-width:1px}
table.frame-sides{border-width:0 1px}
table.frame-topbot{border-width:1px 0}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{display:table-cell;line-height:1.6;background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
td>div.verse{white-space:pre}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.unstyled,ol.unnumbered,ul.checklist,ul.none{list-style-type:none}
ul.unstyled,ol.unnumbered,ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1em;font-size:.85em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{width:1em;position:relative;top:1px}
ul.inline{margin:0 auto .625em auto;margin-left:-1.375em;margin-right:0;padding:0;list-style:none;overflow:hidden}
ul.inline>li{list-style:none;float:left;margin-left:1.375em;display:block}
ul.inline>li>*{display:block}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist>table tr>td:first-of-type{padding:0 .75em;line-height:1}
.colist>table tr>td:last-of-type{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left,.imageblock[style*="float: left"]{margin:.25em .625em 1.25em 0}
.imageblock.right,.imageblock[style*="float: right"]{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em 0;border-width:1px 0 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;text-indent:-1.05em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background-color:#00fafa}
.black{color:#000}
.black-background{background-color:#000}
.blue{color:#0000bf}
.blue-background{background-color:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background-color:#fa00fa}
.gray{color:#606060}
.gray-background{background-color:#7d7d7d}
.green{color:#006000}
.green-background{background-color:#007d00}
.lime{color:#00bf00}
.lime-background{background-color:#00fa00}
.maroon{color:#600000}
.maroon-background{background-color:#7d0000}
.navy{color:#000060}
.navy-background{background-color:#00007d}
.olive{color:#606000}
.olive-background{background-color:#7d7d00}
.purple{color:#600060}
.purple-background{background-color:#7d007d}
.red{color:#bf0000}
.red-background{background-color:#fa0000}
.silver{color:#909090}
.silver-background{background-color:#bcbcbc}
.teal{color:#006060}
.teal-background{background-color:#007d7d}
.white{color:#bfbfbf}
.white-background{background-color:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background-color:#fafa00}
span.icon>.fa{cursor:default}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note:before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip:before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning:before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution:before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important:before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background-color:rgba(0,0,0,.8);-webkit-border-radius:100px;border-radius:100px;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]:after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background-color:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@media print{@page{margin:1.25cm .75cm}
*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare):after,a[href^="https:"]:not(.bare):after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]:after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #ddddd8!important;padding-bottom:0!important}
.sect1{padding-bottom:0!important}
.sect1+.sect1{border:0!important}
#header>h1:first-child{margin-top:1.25rem}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em 0}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span:before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]:before{display:block}
#footer{background:none!important;padding:0 .9375em}
#footer-text{color:rgba(0,0,0,.6)!important;font-size:.9em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.6.3/css/font-awesome.min.css">
</head>
<body class="book toc2 toc-right">
<div id="header">
<h1>Docker. Una nueva forma de ejecutar y desarrollar aplicaciones</h1>
<div class="details">
<span id="author" class="author">Cloud-DI Team - Departamento de Informática. UAL</span><br>
</div>
<div id="toc" class="toc2">
<div id="toctitle">Tabla de contenidos</div>
<ul class="sectlevel1">
<li><a href="#trueresumen">Resumen</a></li>
<li><a href="#trueconceptos-b-sicos">1. Conceptos básicos</a>
<ul class="sectlevel2">
<li><a href="#trueel-t-pico">1.1. El tópico</a></li>
<li><a href="#trueconviene-no-confundir">1.2. Conviene no confundir</a></li>
<li><a href="#truequ-es-docker">1.3. Qué es Docker</a></li>
<li><a href="#truedocker-vs-m-quinas-virtuales">1.4. Docker vs Máquinas virtuales</a></li>
<li><a href="#trueventajas">1.5. Ventajas</a></li>
<li><a href="#truecontenedores-e-im-genes">1.6. Contenedores e imágenes</a></li>
</ul>
</li>
<li><a href="#trueun-ejemplo-sencillo">2. Un ejemplo sencillo</a>
<ul class="sectlevel2">
<li><a href="#trueantes-de-nada">2.1. Antes de nada</a></li>
<li><a href="#truedocker-engine">2.2. Docker engine</a></li>
<li><a href="#trueel-hola-mundo">2.3. El Hola mundo</a></li>
<li><a href="#truecrear-un-contenedor-apache">2.4. Crear un contenedor Apache</a></li>
<li><a href="#truefuncionamiento-b-sico-con-docker">2.5. Funcionamiento básico con Docker</a></li>
<li><a href="#trueim-genes-interesantes-de-docker">2.6. Imágenes interesantes de Docker</a></li>
<li><a href="#trueoperaciones-sobre-contenedores">2.7. Operaciones sobre contenedores</a></li>
<li><a href="#trueresumen-de-comandos-b-sicos-para-contenedores">2.8. Resumen de comandos básicos para contenedores</a></li>
</ul>
</li>
<li><a href="#truecreaci-n-de-im-genes-propias">3. Creación de imágenes propias</a>
<ul class="sectlevel2">
<li><a href="#trueel-code-dockerfile-code">3.1. El <code>Dockerfile</code></a></li>
<li><a href="#trueim-genes">3.2. Imágenes</a></li>
<li><a href="#trueejemplo-de-contenedor-para-aplicaciones-web-en-php">3.3. Ejemplo de contenedor para aplicaciones web en PHP</a></li>
<li><a href="#trueejemplo-de-contenedor-con-volumen-externo">3.4. Ejemplo de contenedor con volumen externo</a></li>
<li><a href="#truedescarga-y-subida-de-im-genes-a-docker-hub">3.5. Descarga y subida de imágenes a Docker Hub</a></li>
<li><a href="#trueresumen-de-comandos-b-sicos-para-im-genes">3.6. Resumen de comandos básicos para imágenes</a></li>
</ul>
</li>
<li><a href="#trueaplicaciones-con-varios-contenedores">4. Aplicaciones con varios contenedores</a>
<ul class="sectlevel2">
<li><a href="#trueflujo-de-trabajo-b-sico-con-docker-compose">4.1. Flujo de trabajo básico con Docker Compose</a></li>
<li><a href="#truecomandos-b-sicos-para-docker-compose">4.2. Comandos básicos para Docker Compose</a></li>
</ul>
</li>
<li><a href="#trueejemplo-aplicaci-n-web-php-con-soporte-de-base-de-datos-mysql">5. Ejemplo: Aplicación web (PHP) con soporte de Base de datos (MySQL)</a></li>
<li><a href="#trueplataformas-de-gesti-n-de-contenedores">6. Plataformas de gestión de contenedores</a>
<ul class="sectlevel2">
<li><a href="#trueadministraci-n-de-docker-con-em-portainer-em">6.1. Administración de Docker con <em>Portainer</em></a></li>
<li><a href="#trueadministraci-n-de-docker-con-rancher-1-6-rancher-server">6.2. Administración de Docker con Rancher 1.6 (Rancher Server)</a></li>
</ul>
</li>
<li><a href="#trueescalado-de-aplicaciones-con-docker-swarm">7. Escalado de aplicaciones con Docker Swarm</a>
<ul class="sectlevel2">
<li><a href="#trueorquestaci-n-de-contenedores">7.1. Orquestación de contenedores</a></li>
<li><a href="#trueorquestadores-de-contenedores-m-s-populares">7.2. Orquestadores de contenedores más populares</a></li>
<li><a href="#truedocker-swarm">7.3. Docker Swarm</a></li>
<li><a href="#truerecuperaci-n-autom-tica-ante-errores-em-self-healing-em">7.4. Recuperación automática ante errores (<em>Self-healing</em>)</a></li>
<li><a href="#trueescalado-de-la-aplicaci-n">7.5. Escalado de la aplicación</a></li>
<li><a href="#trueresumen-de-los-comandos-para-em-swarms-em">7.6. Resumen de los comandos para <em>swarms</em></a></li>
</ul>
</li>
<li><a href="#truedocker-machine">8. Docker machine</a>
<ul class="sectlevel2">
<li><a href="#truecreaci-n-de-archivo-con-variables-de-entorno">8.1. Creación de archivo con variables de entorno</a></li>
<li><a href="#truecreaci-n-de-los-nodos-del-em-swarm-em">8.2. Creación de los nodos del <em>swarm</em></a></li>
<li><a href="#truecomprobaci-n-del-em-swarm-em-creado">8.3. Comprobación del <em>swarm</em> creado</a></li>
<li><a href="#truedespliegue-de-la-aplicaci-n-en-los-nodos">8.4. Despliegue de la aplicación en los nodos</a></li>
<li><a href="#truedesalojo-de-un-nodo">8.5. Desalojo de un nodo</a></li>
</ul>
</li>
<li><a href="#truecreaci-n-de-clusters-kubernetes-con-rancher-2-0">9. Creación de clusters Kubernetes con Rancher 2.0</a></li>
<li><a href="#trueotras-cosas-interesantes">10. Otras cosas interesantes</a>
<ul class="sectlevel2">
<li><a href="#truemicroservicios-y-contenedores">10.1. Microservicios y contenedores</a></li>
<li><a href="#trueel-ecosistema-docker">10.2. El ecosistema Docker</a></li>
<li><a href="#trueinstalar-un-registro-de-im-genes-propio">10.3. Instalar un registro de imágenes propio</a></li>
<li><a href="#trueconexi-n-a-daemons-docker-remotos">10.4. Conexión a daemons Docker remotos</a></li>
<li><a href="#trueuso-de-haproxy">10.5. Uso de HAProxy</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div id="preamble">
<div class="sectionbody">
<div class="imageblock">
<div class="content">
<img src="./images/di.png" alt="di.png">
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueresumen"><a class="anchor" href="#trueresumen"></a>Resumen</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Docker es un proyecto open source creado en 2013 y que ha supuesto una revolución para el desarrollo y despliegue de operaciones. Docker abstrae el hardware y el sistema operativo del host ejecutando las aplicaciones en contenedores, compartimentos aislados que contienen todos los recursos para una aplicación o servicio.</p>
</div>
<div class="paragraph">
<p>En este seminario veremos cómo usar Docker para el desarrollo de aplicaciones sencillas, aprendiendo a crear servicios con <em>Docker Compose</em>, clusters con <em>Docker Swarm</em> e interactuar de forma remota con <em>Docker machine</em></p>
</div>
<div class="ulist">
<div class="title">Objetivos</div>
<ul>
<li>
<p>Conocer los componentes básicos de Docker</p>
</li>
<li>
<p>Crear contenedores a partir de imágenes de Docker Hub</p>
</li>
<li>
<p>Aprender a usar <code>Dockerfile</code> para la creación de imágenes</p>
</li>
<li>
<p>Usar <em>Docker Compose</em> para construir entornos de contenedores</p>
</li>
<li>
<p>Usar volúmenes para almacenamiento persistente</p>
</li>
<li>
<p>Estudiar <em>Docker Swarm</em> para el escalado de aplicaciones</p>
</li>
<li>
<p>Crear clusters con <em>Docker Machine</em></p>
</li>
<li>
<p>Estudiar ejemplos de entornos elásticos</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Disponibles los repositorios usados en este seminario:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Catálogo de clientes: <a href="https://github.com/ualmtorres/docker_customer_catalog">https://github.com/ualmtorres/docker_customer_catalog</a></p>
</li>
<li>
<p>Swarm: <a href="https://github.com/ualmtorres/swarm">https://github.com/ualmtorres/swarm</a></p>
</li>
</ul>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueconceptos-b-sicos"><a class="anchor" href="#trueconceptos-b-sicos"></a>1. Conceptos básicos</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="trueel-t-pico"><a class="anchor" href="#trueel-t-pico"></a>1.1. El tópico</h3>
<div class="imageblock">
<div class="content">
<img src="./images/ItWorksOnMyMachine.jpg" alt="ItWorksOnMyMachine.jpg">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconviene-no-confundir"><a class="anchor" href="#trueconviene-no-confundir"></a>1.2. Conviene no confundir</h3>
<div class="imageblock">
<div class="content">
<img src="./images/Morales.jpg" alt="Morales.jpg" width="100%">
</div>
<div class="title">Figure 1. Contenedores El Morales es una empresa almeriense de alquiler de contenedores de obra</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Dockers.jpg" alt="Dockers.jpg" width="100%">
</div>
<div class="title">Figure 2. Dockers es una marca de prendas de ropa y calzado</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Vallenato.jpg" alt="Vallenato.jpg" width="100%">
</div>
<div class="title">Figure 3. El Vallenato es un género musical colombiano</div>
</div>
</div>
<div class="sect2">
<h3 id="truequ-es-docker"><a class="anchor" href="#truequ-es-docker"></a>1.3. Qué es Docker</h3>
<div class="ulist">
<ul>
<li>
<p>Docker es una plataforma para que desarrolladores y administradores puedan desarrollar, desplegar y ejecutar aplicaciones en un entorno aislado denominado contenedor.</p>
</li>
<li>
<p>Docker permite separar las aplicaciones de la infraestructura acelerando el proceso de entrega de software a producción.</p>
</li>
<li>
<p>Proyecto open source creado en 2013 que hace uso de LXC (Linux Containers). LXC es un método de virtualización de a nivel de S.O.</p>
</li>
</ul>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Docker permite empaquetar una aplicación con todas sus dependencias para que pueda ser ejecutada en plataformas diferentes. <strong>El proceso de despliegue es rápido y repetible.</strong></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Basta con ejecutar los tres comandos siguientes en una máquina con Docker instalado para tener una aplicación web que muestra un catálogo de clientes almacenados en una base de datos MySQL.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ git clone https://github.com/ualmtorres/docker_customer_catalog.git
$ cd docker_customer_catalog
$ docker-compose up -d</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CustomerCatalog.png" alt="CustomerCatalog.png">
</div>
<div class="title">Figure 4. Aplicación sencilla que muestra un listado de clientes de una base de datos</div>
</div>
</div>
<div class="sect2">
<h3 id="truedocker-vs-m-quinas-virtuales"><a class="anchor" href="#truedocker-vs-m-quinas-virtuales"></a>1.4. Docker vs Máquinas virtuales</h3>
<div class="imageblock">
<div class="content">
<img src="./images/DockerVsMV.png" alt="DockerVsMV.png">
</div>
<div class="title">Figure 5. Docker vs Máquinas virtuales</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Una máquina virtual proporciona un entorno con más recursos de los que necesitan la mayoría de las aplicaciones</p>
</li>
<li>
<p>Mayor número de contenedores que de MV en el mismo hardware.</p>
</li>
<li>
<p>Los contenedores se pueden ejecutar en hosts que sean máquinas virtuales.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="trueventajas"><a class="anchor" href="#trueventajas"></a>1.5. Ventajas</h3>
<div class="ulist">
<ul>
<li>
<p>Ligeros: Los contenedores comparten el kernel del host.</p>
</li>
<li>
<p>Intercambiables: Depliegue de actualizaciones en caliente.</p>
</li>
<li>
<p>Portables: Build local y ejecución en cualquier lugar.</p>
</li>
<li>
<p>Escalables: Aumento y distribución automática de réplicas de contenedores.</p>
</li>
<li>
<p>Apilables: Aumento del stack de servicios en caliente.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Docker supone una revolución en los entornos de CI/CD. Tras la actualización del repositorio de proyecto, se crean contenedores para pasar las pruebas, se construyen las nuevas imágenes y se despliega la nueva versión de la aplicación <strong>sin parada del sistema</strong>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truecontenedores-e-im-genes"><a class="anchor" href="#truecontenedores-e-im-genes"></a>1.6. Contenedores e imágenes</h3>
<div class="ulist">
<ul>
<li>
<p>Un contenedor se lanza ejecutando una imagen.</p>
</li>
<li>
<p>Una imagen es una plantilla con las instrucciones de creación de un contenedor Docker:</p>
<div class="ulist">
<ul>
<li>
<p>Código</p>
</li>
<li>
<p>Runtime</p>
</li>
<li>
<p>Librerías</p>
</li>
<li>
<p>Variables de entorno</p>
</li>
<li>
<p>Archivos de configuración</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueun-ejemplo-sencillo"><a class="anchor" href="#trueun-ejemplo-sencillo"></a>2. Un ejemplo sencillo</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="trueantes-de-nada"><a class="anchor" href="#trueantes-de-nada"></a>2.1. Antes de nada</h3>
<div class="sect3">
<h4 id="trueinstalaci-n"><a class="anchor" href="#trueinstalaci-n"></a>2.1.1. Instalación:</h4>
<div class="paragraph">
<p><a href="https://docs.docker.com/install/#desktop">https://docs.docker.com/install/#desktop</a></p>
</div>
<div class="paragraph">
<p>Obtenemos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Daemon de docker</p>
</li>
<li>
<p>Cliente de docker</p>
</li>
<li>
<p>Docker compose</p>
</li>
</ul>
</div>
</div>
<div class="sect3">
<h4 id="truecrear-cuenta-en-docker-hub"><a class="anchor" href="#truecrear-cuenta-en-docker-hub"></a>2.1.2. Crear cuenta en Docker Hub</h4>
<div class="paragraph">
<p>Docker Hub es un registro público de imágenes (Lugar donde se almacenan imágenes): <a href="https://hub.docker.com/">https://hub.docker.com</a></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Docker Hub permite en su plan libre tener un repositorio privado de imágenes.
También permite automatizar la construcción de imágenes y su despliegue con repositorios GitHub y Bitbucket</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedocker-engine"><a class="anchor" href="#truedocker-engine"></a>2.2. Docker engine</h3>
<div class="imageblock">
<div class="content">
<img src="./images/DockerEngine.png" alt="DockerEngine.png">
</div>
<div class="title">Figure 6. Componentes de Docker Engine</div>
</div>
</div>
<div class="sect2">
<h3 id="trueel-hola-mundo"><a class="anchor" href="#trueel-hola-mundo"></a>2.3. El Hola mundo</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker --version
Docker version 18.03.1-ce, build 9ee9f40

$ docker run hello-world
Unable to find image 'hello-world:latest' locally
latest: Pulling from library/hello-world
9bb5a5d4561a: Pull complete
Digest: sha256:f5233545e43561214ca4891fd1157e1c3c563316ed8e237750d59bde73361e77
Status: Downloaded newer image for hello-world:latest

Hello from Docker!
This message shows that your installation appears to be working correctly.
....</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecrear-un-contenedor-apache"><a class="anchor" href="#truecrear-un-contenedor-apache"></a>2.4. Crear un contenedor Apache</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker run -d -p 82:80 httpd</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Descarga una imagen si no existe localmente, lanza un contenedor y asocia el puerto 82 del host al puerto 80 del contenedor</p>
</li>
<li>
<p><code>-d</code> lanza el contenedor en modo <em>dettached</em></p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El primer puerto que aparece es el del host y el segundo el del contenedor</p>
</div>
</td>
</tr>
</table>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>También podemos usar el parámetro <code>--name &lt;nombre&gt;</code> para darle un nombre al contenedor. De forma predeterminada, Docker asigna un nombre aleatorio a los contenedores creados. El asignar un nombre es útil para administrar posteriormente los contenedores (pausa, eliminación, &#8230;&#8203;)</p>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Apache.png" alt="Apache.png">
</div>
<div class="title">Figure 7. Contenedor ejecutando Apache</div>
</div>
</div>
<div class="sect2">
<h3 id="truefuncionamiento-b-sico-con-docker"><a class="anchor" href="#truefuncionamiento-b-sico-con-docker"></a>2.5. Funcionamiento básico con Docker</h3>
<div class="imageblock">
<div class="content">
<img src="./images/FuncionamientoBasico.png" alt="FuncionamientoBasico.png" width="100%">
</div>
<div class="title">Figure 8. Funcionamiento básico con Docker</div>
</div>
</div>
<div class="sect2">
<h3 id="trueim-genes-interesantes-de-docker"><a class="anchor" href="#trueim-genes-interesantes-de-docker"></a>2.6. Imágenes interesantes de Docker</h3>
<div class="paragraph">
<p>En <a href="https://hub.docker.com/explore/">https://hub.docker.com/explore/</a> se encuentran las imágenes ordenadas por popularidad. Destacamos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>alpine: Linux reducido</p>
</li>
<li>
<p>nginx: Servidor web Nginx</p>
</li>
<li>
<p>httpd: Servidor web Apache</p>
</li>
<li>
<p>ubuntu: Ubuntu</p>
</li>
<li>
<p>redis: Base de datos Redis (clave-valor)</p>
</li>
<li>
<p>mongo: Base de datos MongoDB (documentos)</p>
</li>
<li>
<p>mysql: Base de datos MySQL (relacional)</p>
</li>
<li>
<p>postgres: Base de datos PostgreSQL (relaional)</p>
</li>
<li>
<p>node: Node.js</p>
</li>
<li>
<p>registry: Registro de imágenes on-premise</p>
</li>
<li>
<p>php, elasticsearch, haproxy, wordpress, rabbitmq, python, openjdk, tomcat, jenkins, redmine, flink, spark, &#8230;&#8203;</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="trueoperaciones-sobre-contenedores"><a class="anchor" href="#trueoperaciones-sobre-contenedores"></a>2.7. Operaciones sobre contenedores</h3>
<div class="sect3">
<h4 id="truemostrar-contenedores"><a class="anchor" href="#truemostrar-contenedores"></a>2.7.1. Mostrar contenedores</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
d2f73e6acd51        httpd               "httpd-foreground"       11 minutes ago      Up 11 minutes       0.0.0.0:82-&gt;80/tcp       upbeat_stonebraker</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los nombres generados para los contenedores son aleatorios si no se usa el parámetro <code>-name</code> al crearlos.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truedetener-y-reanudar-contenedores"><a class="anchor" href="#truedetener-y-reanudar-contenedores"></a>2.7.2. Detener y reanudar contenedores</h4>
<div class="paragraph">
<p>Primero, obtener con <code>docker ps</code> el <code>CONTAINER ID</code> del contenedor que queremos detener.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
d2f73e6acd51        httpd               "httpd-foreground"       11 minutes ago      Up 11 minutes       0.0.0.0:82-&gt;80/tcp       upbeat_stonebraker</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Detener el contenedor</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker stop d2f73e6acd51</code></pre>
</div>
</div>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Al hacer <code>docker ps</code> no se muestran los contenedores que estén detenidos.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><strong>Mostrar todos los contenedores, también los detenidos</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker ps -a
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS                        PORTS                    NAMES
d2f73e6acd51        httpd               "httpd-foreground"       20 minutes ago      Exited (0) 2 minutes ago                               upbeat_stonebraker</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Reanudar un contenedor</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker start d2f73e6acd51</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras reanudar el contenedor, vuelve a aparecer cuando hacemos <code>docker ps</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS                    NAMES
d2f73e6acd51        httpd               "httpd-foreground"       9 hours ago         Up 10 seconds       0.0.0.0:82-&gt;80/tcp       upbeat_stonebraker</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Detener todos los contenedores en ejecución</strong></p>
</div>
<div class="paragraph">
<p>Primero obtenenemos los identificadores de los contenedores en ejecución con <code>docker ps -q</code>. Ese comando lo podemos encerrar entre apóstrofes y pasar su resultado a otro comando en la misma línea.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker stop `docker ps -q`</code></pre>
</div>
</div>
<div class="paragraph">
<p><strong>Iniciar una lista de contenedores</strong></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker start d2f73e6acd51 9811efbf6e45 178c2d03f2e7</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueabrir-un-terminal-en-un-contenedor"><a class="anchor" href="#trueabrir-un-terminal-en-un-contenedor"></a>2.7.3. Abrir un terminal en un contenedor</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker exec -it d2f73e6acd51 bash
root@d2f73e6acd51:/usr/local/apache2#</code></pre>
</div>
</div>
<div class="paragraph">
<p>Se inicia una sesión como <code>root</code> en el contenedor. En la terminal del contenedor podemos ejecutar comandos del sistema operativo (<code>ls, df -h, cat /proc/cpuinfo, &#8230;&#8203;</code>). La cantidad y el tipo de comandos dependerá de la imagen usada para crear el contenedor.</p>
</div>
</div>
<div class="sect3">
<h4 id="truecopia-de-datos"><a class="anchor" href="#truecopia-de-datos"></a>2.7.4. Copia de datos</h4>
<div class="admonitionblock caution">
<table>
<tr>
<td class="icon">
<i class="fa icon-caution" title="Caution"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El almacenamiento en un contenedor no es persistente. Se eliminan los datos escritos en él tras su eliminación.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker cp [OPTIONS] CONTAINER:SRC_PATH DEST_PATH|-
docker cp [OPTIONS] SRC_PATH|- CONTAINER:DEST_PATH</code></pre>
</div>
</div>
<div class="paragraph">
<p>Como ejemplo vamos a crear en nuestro host un archivo <code>index.html</code> y lo copiaremos en el contenedor para sustituir la página de inicio del servidor Apache.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;!-- Ejemplo de archivo index.html --&gt;
&lt;html&gt;
  &lt;body&gt;
    &lt;h1&gt;Docker es una maravilla&lt;/h1&gt;
  &lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora copiamos el archivo <code>index.html</code> al contenedor con <code>docker cp</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker cp index.html d2f73e6acd51:/usr/local/apache2/htdocs/</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/CambioIndexApache.png" alt="CambioIndexApache.png">
</div>
<div class="title">Figure 9. Cambio de página de inicio</div>
</div>
</div>
<div class="sect3">
<h4 id="trueeliminaci-n-de-un-contenedor"><a class="anchor" href="#trueeliminaci-n-de-un-contenedor"></a>2.7.5. Eliminación de un contenedor</h4>
<div class="paragraph">
<p>Primero paramos el contenedor con <code>docker stop</code> y luego lo eliminamos con <code>docker rm</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker stop d2f73e6acd51
$ docker rm d2f73e6acd51</code></pre>
</div>
</div>
<div class="paragraph">
<p>También se puede eliminar directamente un contenedor en ejecución forzando su eliminación</p>
</div>
<div class="paragraph">
<p><code>$ docker rm -f &lt;id&gt;</code></p>
</div>
<div class="paragraph">
<p>Al crear un nuevo contenedor a partir de la imagen <code>httpd</code> comprobamos que la página de inicio modificada anteriormente se eliminó junto al contenedor eliminado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker run -d -p 82:80 httpd</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Podemos eliminar todos los contenedores creados a partir de una imagen con la secuencia de comandos siguiente (p.e. eliminar todos los contenedores creados a partir de una imagen <code>wordpress</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker rm -f `docker ps -a | grep "wordpress" | awk '{print $1}'`</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueresumen-de-comandos-b-sicos-para-contenedores"><a class="anchor" href="#trueresumen-de-comandos-b-sicos-para-contenedores"></a>2.8. Resumen de comandos básicos para contenedores</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">$ docker info
$ docker version
$ docker run &lt;image&gt; // Crea un contenedor a partir de una imagen. Si no tenemos la imagen en local, la descarga
$ docker run -d -p 82:80 nginx: Crea un contenedor en modo deattached accesible desde el puerto 82
$ docker stop|start &lt;id&gt;: Detiene|Continúa un contenedor
$ docker ps -a: Listado de contenedores (-a muestra también los parados)
$ docker ps -q: Listado de los ids de los contenedores
$ docker stop `docker ps -q`: Para todos los contenedores que devuelve el subcomando `docker ps -q`
$ docker rm &lt;id&gt;: Borra un contenedor si está parado
$ docker rm -f &lt;id&gt;: Fuerza el borrado de un contenedor aunque esté parado
$ docker exec -it &lt;id&gt; sh: Abre una terminal en el contenedor
$ docker exec &lt;id&gt; ls: Ejecuta el comando ls en el contenedor para mostrar sus archivos
$ docker cp &lt;id&gt;:./dockerenv .: Copia el fichero dockerenv del contenedor en nuestro sistema de archivos local
$ docker rm -f `docker ps -a | grep "wordpress" | awk '{print $1}'`: Eliminar todos los contenedores creados a partir de una imagen</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreaci-n-de-im-genes-propias"><a class="anchor" href="#truecreaci-n-de-im-genes-propias"></a>3. Creación de imágenes propias</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="trueel-code-dockerfile-code"><a class="anchor" href="#trueel-code-dockerfile-code"></a>3.1. El <code>Dockerfile</code></h3>
<div class="ulist">
<ul>
<li>
<p>Para construir una imagen, se crea un <code>Dockerfile</code> con las instrucciones que especifican lo que va a ir en el entorno, dentro del contenedor (redes, volúmenes, puertos al exterior, archivos que se incluyen.</p>
</li>
<li>
<p>Indica cómo y con qué construir la imagen.</p>
</li>
<li>
<p>Conseguimos que el build de la aplicación definida en el contenedor se comporte de la misma forma en cualquier lugar que se ejecute. Hacemos que sea repetible.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Ejemplo de <code>Dockerfile</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code># Use an official Python runtime as a parent image
FROM python:2.7-slim

# Set the working directory to /app
WORKDIR /app

# Copy the current directory contents into the container at /app
ADD . /app

# Install any needed packages specified in requirements.txt
RUN pip install --trusted-host pypi.python.org -r requirements.txt

# Make port 80 available to the world outside this container
EXPOSE 80

# Define environment variable
ENV NAME World

# Run app.py when the container launches
CMD ["python", "app.py"]</code></pre>
</div>
</div>
<div class="paragraph">
<p>Fragmento de <code>Dockerfile</code> para construir una imagen con Ubuntu como base y definiendo dónde se montará un volumen externo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>FROM ubuntu:latest
RUN apt-get update -y
RUN apt-get install -y python-pip python-dev
WORKDIR /app
ENV DEBUG=True
EXPOSE 80
VOLUME /data <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Crea un punto de montaje en el contenedor. A la hora de crearlo le haremos corresponder normalmente un directorio del host</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueim-genes"><a class="anchor" href="#trueim-genes"></a>3.2. Imágenes</h3>
<div class="ulist">
<ul>
<li>
<p>Se construyen con <code>docker build</code> a partir de un <code>Dockerfile</code></p>
</li>
<li>
<p>Se crean en un contexto (normalmente añadiendo archivos del directorio de trabajo del host a la imagen -p.e. el código fuente de la aplicación)</p>
</li>
<li>
<p>Con <code>FROM</code> (normalmente primera instrucción del <code>Dockerfile</code>) inicializamos el sistema de archivos de la imagen (p.e. si es ubuntu obtenemos el sistema de archivos de Ubuntu)</p>
</li>
<li>
<p>Muchas imágenes disponibles en Docker Hub usan Alpine (una distribución ligera de Linux) en lugar de Ubuntu, Fedora o CentOS, debido a su menor tamaño</p>
</li>
<li>
<p>Cada instrucción del <code>Dockerfile</code> genera una nueva capa (con la diferencia) en ese sistema de archivos</p>
</li>
<li>
<p>Al hacer <code>build</code> las capas existentes en el registro local no se vuelven a crear</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Una <a href="https://hub.docker.com/r/library/alpine/tags/">imagen comprimida de Alpine</a> está en torno a los 2 MB, mientras que una <a href="https://hub.docker.com/r/library/ubuntu/tags/">imagen comprimida de Ubuntu</a> está entre 40 y 80 MB</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="trueejemplo-de-contenedor-para-aplicaciones-web-en-php"><a class="anchor" href="#trueejemplo-de-contenedor-para-aplicaciones-web-en-php"></a>3.3. Ejemplo de contenedor para aplicaciones web en PHP</h3>
<div class="paragraph">
<p>Vamos a construir un contenedor que incluya de forma estática una aplicación (p.e. la última versión de la aplicación). El proceso a seguir es:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Creación de la aplicación.</p>
</li>
<li>
<p>Creación del <code>Dockerfile</code> para generación de la imagen.</p>
</li>
<li>
<p>Generación de la imagen.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>A partir de una carpeta nueva crearemos lo siguiente:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Archivo <code>Dockerfile</code></p>
</li>
<li>
<p>Carpeta <code>html</code> con los scritps de nuestra aplicación</p>
</li>
<li>
<p>Archivo <code>html/index.php</code> con el código de nuestra aplicación</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>El <code>Dockerfile</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>FROM ualmtorres/phalcon-apache-ubuntu

ADD html /var/www/html

EXPOSE 80</code></pre>
</div>
</div>
<div class="paragraph">
<p>Archivo <code>html/index.php</code> de ejemplo</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;?php
  echo "Hola desde Docker";
?&gt;</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="trueconstrucci-n-de-la-imagen"><a class="anchor" href="#trueconstrucci-n-de-la-imagen"></a>3.3.1. Construcción de la imagen.</h4>
<div class="paragraph">
<p><code>$ docker build -t pruebaphp .</code></p>
</div>
<div class="paragraph">
<p>Con <code>-t</code> definimos una etiqueta o nombre de la imagen. Al construir la imagen pasa a nuestro registro local.</p>
</div>
</div>
<div class="sect3">
<h4 id="truelistado-de-im-genes-locales"><a class="anchor" href="#truelistado-de-im-genes-locales"></a>3.3.2. Listado de imágenes locales</h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker image ls
REPOSITORY             TAG                 IMAGE ID            CREATED             SIZE
pruebaphp              latest              152781e32617        14 hours ago        245MB</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-de-un-contenedor-a-partir-de-la-imagen"><a class="anchor" href="#truecreaci-n-de-un-contenedor-a-partir-de-la-imagen"></a>3.3.3. Creación de un contenedor a partir de la imagen</h4>
<div class="paragraph">
<p><code>$ docker run -d -p 83:80 pruebaphp</code></p>
</div>
<div class="paragraph">
<p>Un posible inconveniente que podemos encontrar en este ejemplo es que la aplicación va incluida en la propia imagen, por lo que para actualizar la aplicación deberemos crear una nueva imagen, y después crear un nuevo contenedor a partir de ella desechando el contenedor anterior.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A la hora de distribuir y actualizar aplicaciones podemos incluir la aplicación en la imagen. Con un ciclo de CI/CD tendríamos la aplicación actualizada al actualizar su repositorio.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueejemplo-de-contenedor-con-volumen-externo"><a class="anchor" href="#trueejemplo-de-contenedor-con-volumen-externo"></a>3.4. Ejemplo de contenedor con volumen externo</h3>
<div class="paragraph">
<p>En este ejemplo la aplicación la tendremos aparte en un volumen externo accesible por el contenedor. De esta forma, si nuestra aplicación está vinculada a un repositorio, la actualización de la aplicación se realiza descargando la última versión del repositorio, manteniendo intacto el contenedor.</p>
</div>
<div class="paragraph">
<p>La forma de usar volúmenes con <code>Dockerfile</code> consiste en:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Añadir en el <code>Dockerfile</code> la lista de carpetas que se montarán con volúmenes externos</p>
</li>
<li>
<p>Al crear el contenedor indicar el punto de montaje en el host remoto en forma de ruta absoluta</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>El <code>Dockerfile</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>FROM ualmtorres/phalcon-apache-ubuntu

VOLUME /var/www/html

EXPOSE 80</code></pre>
</div>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker run -d -p 83:80 -v=/Users/manolo/Documents/Desarrollo/SeminarioDocker/phpsimple/html:/var/www/html pruebaphp</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>También podemos hacer uso de la evaluación de órdenes con apóstrofes para obtener el path actual y añadirle sólo la carpeta <code>html</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker run -d -p 83:80 -v=`pwd`/html:/var/www/html pruebaphp</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="truedescarga-y-subida-de-im-genes-a-docker-hub"><a class="anchor" href="#truedescarga-y-subida-de-im-genes-a-docker-hub"></a>3.5. Descarga y subida de imágenes a Docker Hub</h3>
<div class="ulist">
<ul>
<li>
<p>Etiquetar la imagen antes de subirla a Docker Hub</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker tag phpprueba ualmtorres/phpprueba:v0</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Subida de la imagen a Docker Hub</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker push &lt;usuario&gt;/&lt;image&gt;</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Al hacer <code>push</code> las capas que ya estén subidas no se vuelven a subir. En cuanto una instrucción del <code>Dockerfile</code> cambia una capa, invalida al resto y hay que volver a generar las instrucciones de las capas restantes. Por tanto, colocaremos antes en el <code>Dockerfile</code> lo que menos cambie.</p>
</li>
<li>
<p>Al hacer <code>pull</code> sólo se descargan las capas nuevas.</p>
</li>
<li>
<p>Si cambiamos en el host archivos de los que se incluyen en la imagen se genera una capa nueva invalidando la caché.</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker pull wordpress
$ docker run -d -p 80:80 --name my_wordpress wordpress</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueresumen-de-comandos-b-sicos-para-im-genes"><a class="anchor" href="#trueresumen-de-comandos-b-sicos-para-im-genes"></a>3.6. Resumen de comandos básicos para imágenes</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker login
$ docker run -d ngninx
$ docker pull &lt;image&gt;
$ docker image ls: Lista imágenes locales
$ docker inspect &lt;image&gt;: Propiedades de una imagen
$ docker image rm &lt;image&gt;: Elimina una imagen local</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueaplicaciones-con-varios-contenedores"><a class="anchor" href="#trueaplicaciones-con-varios-contenedores"></a>4. Aplicaciones con varios contenedores</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Docker Compose es una herramienta para definir y ejecutar aplicaciones Docker con varios contenedores.</p>
</li>
<li>
<p>Usaremos un archivo <code>docker-compose.yml</code> para configurar los <em>servicios</em> de la aplicación. Los servicios son las partes de la aplicación (p.e. un servicio para el almacenamiento de los datos y otro para el front-end)</p>
</li>
<li>
<p>En un mismo host podemos tener varios entonos aislados. Compose usa nombres de proyecto para mantener a los entornos aislados. De forma predeterminada se usa el nombre del directorio desde donde se lanza la aplicación.</p>
</li>
<li>
<p><code>docker-compose --version</code> para obtener la versión y saber si está instalado.</p>
</li>
<li>
<p>Instalación desde <a href="https://docs.docker.com/compose/install">https://docs.docker.com/compose/install</a></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="trueflujo-de-trabajo-b-sico-con-docker-compose"><a class="anchor" href="#trueflujo-de-trabajo-b-sico-con-docker-compose"></a>4.1. Flujo de trabajo básico con Docker Compose</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Crear el archivo <code>docker-compose.yml</code> con los servicios de la aplicación (p.e. php y mysql)</p>
</li>
<li>
<p>Construir y lanzar el entorno en modo <em>dettached</em> con <code>docker-compose up -d</code></p>
</li>
<li>
<p>Echar abajo el entorno con <code>docker-compose down</code></p>
</li>
</ol>
</div>
</div>
<div class="sect2">
<h3 id="truecomandos-b-sicos-para-docker-compose"><a class="anchor" href="#truecomandos-b-sicos-para-docker-compose"></a>4.2. Comandos básicos para Docker Compose</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">$ docker-compose up -d      Construye y lanza el entorno en modo dettached
$ docker-compose pull       Descarga las imágenes pero no inicia los contenedores
$ docker-compose rm [-fs]   Borra los contedores parados. Con -fs los detiene y fuerza su borrado</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueejemplo-aplicaci-n-web-php-con-soporte-de-base-de-datos-mysql"><a class="anchor" href="#trueejemplo-aplicaci-n-web-php-con-soporte-de-base-de-datos-mysql"></a>5. Ejemplo: Aplicación web (PHP) con soporte de Base de datos (MySQL)</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Aplicación que muestra un listado de clientes almacenado en una base de datos MySQL.</p>
</li>
<li>
<p>Podemos distribuirla con un repositorio que incluya una carpeta <code>html</code> con la aplicación PHP.</p>
</li>
<li>
<p>Al iniciar el servicio MySQL se ejecutará un script de inicialización de la base de datos.</p>
</li>
<li>
<p>Usaremos volúmenes externos para la base de datos y para la aplicación web para asegurar la persistencia de los cambios.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Comencemos clonando el repositorio de la aplicación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ git clone https://github.com/ualmtorres/customer_catalog.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>En ese repositorio se encuentra:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Un archivo <code>docker-compose.yml</code> que configura dos serivicios. Un servicio para almacenamiento de datos con MySQL y otro servicio para el front-end PHP de la aplicación.</p>
</li>
<li>
<p>Una carpeta <code>html</code> con la aplicación. Esta carpeta será la que monte el servicio front-end, de forma que la aplicación no está almacenada en el contenedor.</p>
</li>
<li>
<p>Un script SQL <code>init.sql</code> que inicializa la base de datos de nuestra aplicación. La base de datos se almacena en nuestro host, garantizando almacenamiento persistente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p><code>docker-compose.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">version: '2'
services:
  mysql:
    container_name: my_mysql
    restart: always
    image: mysql:5.7
    environment:
      MYSQL_ROOT_PASSWORD: 'secret' # TODO: Change this
    ports:
      - "3306:3306"
    volumes:
      - ./data:/var/lib/mysql <i class="conum" data-value="1"></i><b>(1)</b>
      - ./init.sql:/docker-entrypoint-initdb.d/init.sql <i class="conum" data-value="2"></i><b>(2)</b>
  php:
    container_name: my_php
    restart: always
    image: ualmtorres/phalcon-apache-ubuntu
    ports:
      - "80:80"
    volumes:
      - ./html:/var/www/html <i class="conum" data-value="3"></i><b>(3)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Montar una carpeta <code>data</code> de nuestro host en la ruta en la que el servicio <code>mysql</code> almacena la base de datos</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>La imagen de MySQL ejecutará al inicio cualquier script que encuentre en `/docker-entrypoint-initdb.d/</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Montar una carpeta <code>html</code> de nuestro host en la ruta en la que el servicio <code>php</code> almacena la aplicación</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><code>index.php</code> <a href="https://gist.githubusercontent.com/ualmtorres/0c9ba76eb22a35e328dbc322e6c100d1/raw/812f0db2da07037416db8967130eb16b16b5b88e/index.php">Descargar index.php</a></p>
</div>
<script src="https://gist.github.com/ualmtorres/0c9ba76eb22a35e328dbc322e6c100d1.js"></script>
<div class="paragraph">
<p><code>init.sql</code> <a href="https://gist.githubusercontent.com/ualmtorres/eb328b653fcc5964f976b22c320dc10f/raw/448b00c44d7102d66077a393dad555585862f923/init.sql">Descargar init.sql</a></p>
</div>
<script src="https://gist.github.com/ualmtorres/eb328b653fcc5964f976b22c320dc10f.js"></script>
<div class="imageblock">
<div class="content">
<img src="./images/CustomerCatalog.png" alt="CustomerCatalog.png" width="100%">
</div>
<div class="title">Figure 10. Aplicación web PHP que muestra listado de clientes almacenados en MySQL</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueplataformas-de-gesti-n-de-contenedores"><a class="anchor" href="#trueplataformas-de-gesti-n-de-contenedores"></a>6. Plataformas de gestión de contenedores</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Hasta ahora hemos estado usando Docker a través de Docker CLI. Con Docker CLI creamos contenedores, los mostramos, los detenemos, gestionamos volúmenes, redes, stacks, y demás operaciones.</p>
</div>
<div class="paragraph">
<p>Veamos dos Web UI para la gestión de contenedores como son Portainer y Rancher 1.6. Ambas se distribuyen mediante contedores.</p>
</div>
<div class="sect2">
<h3 id="trueadministraci-n-de-docker-con-em-portainer-em"><a class="anchor" href="#trueadministraci-n-de-docker-con-em-portainer-em"></a>6.1. Administración de Docker con <em>Portainer</em></h3>
<div class="paragraph">
<p><em>Portainer</em> es una Web UI sencilla y potente para administración de entornos Docker locales y remotos. Permite la administración de stacks, servicios, contenedores, imágenes, redes y volúmenes.</p>
</div>
<div class="paragraph">
<p>Para ejecutar <em>Portainer</em> con un carpeta local para el almacenamiento de los datos de Portainer (p.e. usuarios) ejecutaríamos el comando siguiente:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -d \
-p 9000:9000 \
-v "/var/run/docker.sock:/var/run/docker.sock" \
-v `pwd`/portainer_data:/data portainer/portainer \
portainer/portainer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras unos instantes tendremos Portainer en el puerto 9000. Después de definir una cuenta de usuario podremos entrar a administrar nuestro entorno Docker local.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Portainer.png" alt="Portainer.png">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueadministraci-n-de-docker-con-rancher-1-6-rancher-server"><a class="anchor" href="#trueadministraci-n-de-docker-con-rancher-1-6-rancher-server"></a>6.2. Administración de Docker con Rancher 1.6 (Rancher Server)</h3>
<div class="paragraph">
<p>Rancher dispone actualmente de dos versiones con funionalidades diferentes: 1.6 y 2.0</p>
</div>
<div class="paragraph">
<p><a href="https://rancher.com/docs/rancher/v1.6/en/">Rancher 1.6</a> nos permite gestionar las imágenes, contenedores, stacks, volúmenes y demás objetos de Docker.</p>
</div>
<div class="paragraph">
<p>Rancher 2.0 va más allá y además permite gestionar clusters, en especial clusters de Kubernetes en múltiples hosts.</p>
</div>
<div class="paragraph">
<p>Para ejecutar Rancher 1.6 con una carpeta local para el almacenamiento de los datos de Rancher ejecutaríamos el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -d --restart=unless-stopped \
-p 8080:8080 \
-v `pwd`/rancher16_data:/var/lib/mysql \
rancher/server <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>rancher/server</code> es el nombre de la imagen de Rancher 1.6, mientras que <code>rancher/rancher</code> es el nombre de la imagen de Rancher 2.0</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Rancher16.png" alt="Rancher16.png">
</div>
<div class="title">Figure 11. Catálogo de imágenes de Rancher 1.6</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueescalado-de-aplicaciones-con-docker-swarm"><a class="anchor" href="#trueescalado-de-aplicaciones-con-docker-swarm"></a>7. Escalado de aplicaciones con Docker Swarm</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>En aplicaciones distribuidas y con gran demanda podemos replicar contenedores en un servicio.</p>
</li>
<li>
<p>Llegado el caso, necesitamos indicar la cantidad de contenedores que están ejecutando un servicio.</p>
</li>
<li>
<p>También, ajustaremos la cantidad del recursos del host que se dedican a la ejecución de las réplicas.</p>
</li>
<li>
<p>Un balanceador de carga se encargará de ir alternando los contenedores a los que se envían las peticiones.</p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="trueorquestaci-n-de-contenedores"><a class="anchor" href="#trueorquestaci-n-de-contenedores"></a>7.1. Orquestación de contenedores</h3>
<div class="paragraph">
<p>Herramientas que nos ayudan en las tareas de:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Aprovisionamiento de hosts</p>
</li>
<li>
<p>Instanciación de contenedores</p>
</li>
<li>
<p>Sustitución de contenedores erróneos</p>
</li>
<li>
<p><em>Service discovery</em></p>
</li>
<li>
<p>Escalado aumentando o disminuyendo el número de contenedores</p>
</li>
<li>
<p>Configuración de red</p>
</li>
<li>
<p>Balanceo de carga</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="trueorquestadores-de-contenedores-m-s-populares"><a class="anchor" href="#trueorquestadores-de-contenedores-m-s-populares"></a>7.2. Orquestadores de contenedores más populares</h3>
<div class="ulist">
<ul>
<li>
<p>Amazon EC2 Container Service</p>
</li>
<li>
<p>Azure Container Service</p>
</li>
<li>
<p>Docker Swarm (el que veremos en este seminario debido a su sencillez)</p>
</li>
<li>
<p>Kubernetes (el líder del momento)</p>
</li>
<li>
<p>Google Container Engine (construido sobre Kubernetes)</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="truedocker-swarm"><a class="anchor" href="#truedocker-swarm"></a>7.3. Docker Swarm</h3>
<div class="ulist">
<ul>
<li>
<p>Docker Swarm propone que algunos de los conceptos de contenedores en un solo host sean válidos para convertirlo en un cluster (p.e. redes overlay VXLAN)</p>
</li>
<li>
<p>Un cluster de contenedores se ejecuta en un <em>swarm</em> (enjambre).</p>
</li>
<li>
<p>Un <em>swarm</em> es una colección de Docker engines.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/DockerSwarm.jpg" alt="DockerSwarm.jpg" width="100%">
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Docker Swarm permite crear y gestionar clusters de contenedores usando el archivo <code>docker-compose.yml</code>.</p>
</li>
<li>
<p>Un <em>swarm</em> está formado por nodos, que pueden ser máquinas físicas o virtuales.</p>
</li>
<li>
<p>Hay dos tipos de nodos: <em>manager</em> y <em>worker</em>.</p>
<div class="ulist">
<ul>
<li>
<p>Los nodos <em>manager</em> se encargan de mantener el estado del cluster y de planificar los servicios.</p>
</li>
<li>
<p>Los nodos <em>worker</em> sólo se encargan de ejecutar contenedores. De forma predeterminada, al definir un <em>manager</em> también es <em>worker</em>.</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Podemos hace que los <em>managers</em> no sean <em>workers</em> haciendo que su disponibilidad sea <code>drain</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker node update --availability drain</code></pre>
</div>
</div>
<div class="paragraph">
<p>Swarm llevará a otros nodos los trabajos en ejecución y no le asignará nuevos trabajos.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p>La composición del <em>swarm</em> es dinámica. Se pueden añadir y eliminar nodos <em>worker</em> sobre la marcha según sea conveniente. También es posible añadir nuevos nodos <em>manager</em>.</p>
</li>
</ul>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Los nodos <em>worker</em> pueden ser promovidos a <em>manager</em> con <code>docker node promote</code> y los <em>manager</em> pueden ser degradados a <em>worker</em> con <code>docker node demote</code>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-swarm"><a class="anchor" href="#truecreaci-n-del-swarm"></a>7.3.1. Creación del swarm</h4>
<div class="paragraph">
<p>Comenzamos creando una carpeta nueva que podemos denominar <code>swarm</code> para almacenar los archivos del proyecto (<code>docker-compose.yml</code>, código de la aplicación, &#8230;&#8203;)</p>
</div>
<div class="paragraph">
<p>A continuación ejecutamos el comando</p>
</div>
<div class="paragraph">
<p><code>docker swarm init</code></p>
</div>
<div class="paragraph">
<p>Esto crea un <em>swarm</em> de un nodo configurando como <em>manager</em> la máquina sobre la que se ha ejecutado. Ademas, muestra las instrucciones para añadir nuevos nodos <em>worker</em> o <em>manager</em> al <em>swarm</em> creado.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-sh" data-lang="sh">$ docker swarm init
Swarm initialized: current node (uifjsdvl3v1ydv5p7ocif2j13) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-6635wxwy4wun1fvedd3hq27cganpqh28g0zh72ufhrytduewe9-1f6wj5wlzmjyt87ykdoyb1nci 192.168.65.3:2377</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si olvidamos este token lo podemos volver a obtener con</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker swarm join-token worker
To add a worker to this swarm, run the following command:

    SWMTKN-1-6635wxwy4wun1fvedd3hq27cganpqh28g0zh72ufhrytduewe9-1f6wj5wlzmjyt87ykdoyb1nci 192.168.65.3:2377</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="truedefinici-n-de-los-servicios-y-r-plicas"><a class="anchor" href="#truedefinici-n-de-los-servicios-y-r-plicas"></a>7.3.2. Definición de los servicios y réplicas</h4>
<div class="paragraph">
<p>En el archivo <code>docker-compose.yml</code> definiremos cada uno de los servicios de nuestra aplicación, número de réplicas de los servicios y límites de recursos (CPU, RAM) asignados a cada contenedor.</p>
</div>
<div class="paragraph">
<p>Ejemplo de <code>docker-compose.yml</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">version: '3'
services:
  php:
    image: ualmtorres/phalcon-apache-ubuntu
    ports:
      - "80:80"
    volumes:
      - ./html:/var/www/html
    deploy:
      replicas: 3
      resources:
        limits:
          cpus: "0.1"
          memory: 50M
      restart_policy:
        condition: on-failure
    networks:
      - webnet
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    networks:
      - webnet
networks:
  webnet:</code></pre>
</div>
</div>
<div class="paragraph">
<p>En este caso definimos dos servicios: <code>php</code> y <code>visualizer</code>.</p>
</div>
<div class="ulist">
<ul>
<li>
<p><code>php</code> tendrá 3 réplicas. A cada una de ellas le limitamos los recursos al 10% de uso de la CPU del host en el que se ejecuta el contenedor (también se pueden indicar qué núcleos usar) y 50MB de RAM.</p>
</li>
<li>
<p><code>visualizer</code> nos permite crear un contenedor que de forma sencilla muestra la cantidad y el estado de los contenedores de cada nodo del <em>swarm</em>.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>A modo de ejemplo nuestra aplicación mostrará simplemente el id del contenedor donde se está ejecutando para poder ver funcionando el balanceador.</p>
</div>
<div class="paragraph">
<p><code>html/index.php</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>&lt;?php
 echo "Contenedor: " . gethostname();
?&gt;</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="truedespliegue-del-entorno-em-stack-em"><a class="anchor" href="#truedespliegue-del-entorno-em-stack-em"></a>7.3.3. Despliegue del entorno (<em>stack</em>)</h4>
<div class="paragraph">
<p>Para lanzar esta aplicación ejecutaremos el comando siguiente:</p>
</div>
<div class="paragraph">
<p><code>docker stack deploy -c docker-compose.yml my_app</code></p>
</div>
<div class="paragraph">
<p>El parámetro <code>-c</code> es opcional y especifica el archivo <em>compose</em>. <code>my_app</code> es el nombre que le damos al <em>stack</em> creado. Pensemos en un <code>stack</code> como un conjunto de servicios.</p>
</div>
<div class="paragraph">
<p>Tras unos instantes se creará el entorno y estarán ejecutándose la aplicación (puerto 80) y el visualizador (puerto 8080).</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Balanceador.png" alt="Balanceador.png">
</div>
<div class="title">Figure 12. Aplicación mostrando el número de contenedor</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Visualizer.png" alt="Visualizer.png">
</div>
<div class="title">Figure 13. El visualizador</div>
</div>
<div class="paragraph">
<p>Tenemos varios comandos para conocer el estado del <code>stack</code> creado.</p>
</div>
<div class="paragraph">
<p>Con <code>docker stack</code> podemos gestionar <em>stacks</em>. Por ejemplo, con <code>docker stack ls</code> vemos los stacks creados con la cantidad de servicios que incluye cada uno.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker stack ls
NAME                SERVICES
my_app              2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <code>docker service ls</code> vemos los distintos servicios y la cantidad y estado de sus réplicas.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker service ls
ID                  NAME                MODE                REPLICAS            IMAGE                             PORTS
l6gwxu4asxb9        my_app_php          replicated          3/3                 ualmtorres/phalcon-apache-ubuntu:latest           *:80-&gt;80/tcp
27l66joutbnd        my_app_visualizer   replicated          1/1                 dockersamples/visualizer:stable   *:8080-&gt;8080/tcp</code></pre>
</div>
</div>
<div class="paragraph">
<p>Con <code>docker stack ps my_app</code> vemos el estado de cada una de las tareas (contenedores) del <em>stack</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker stack ps my_app
ID                  NAME                  IMAGE                             NODE                    DESIRED STATE       CURRENT STATE            ERROR               PORTS
0kc4fcw7bmva        my_app_visualizer.1   dockersamples/visualizer:stable   linuxkit-025000000001   Running             Running 6 minutes ago
ueb5qs8kb0u6        my_app_php.1          ualmtorres/phalcon-apache-ubuntu:latest           linuxkit-025000000001   Running             Running 6 minutes ago
uejgm1a4035i        my_app_php.2          ualmtorres/phalcon-apache-ubuntu:latest           linuxkit-025000000001   Running             Running 6 minutes ago
nb0cbp5jhail        my_app_php.3          ualmtorres/phalcon-apache-ubuntu:latest           linuxkit-025000000001   Running             Running 6 minutes ago</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truerecuperaci-n-autom-tica-ante-errores-em-self-healing-em"><a class="anchor" href="#truerecuperaci-n-autom-tica-ante-errores-em-self-healing-em"></a>7.4. Recuperación automática ante errores (<em>Self-healing</em>)</h3>
<div class="paragraph">
<p>Veamos como al realizar una operación <code>kill</code> sobre uno de los contenedores, tras unos instantes vuelve a crearse un nuevo contenedor en su puesto, garantizando el número de réplicas especificado.</p>
</div>
<div class="paragraph">
<p>Primero mostramos los contenedores actuales</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker ps
CONTAINER ID        IMAGE                             COMMAND             CREATED             STATUS              PORTS               NAMES
ef0248683123        dockersamples/visualizer:stable   "npm start"         12 minutes ago      Up 12 minutes       8080/tcp            my_app_visualizer.1.0kc4fcw7bmvale0i9unh2ph2m
4be7ebee6e84        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           12 minutes ago      Up 12 minutes       80/tcp              my_app_php.1.ueb5qs8kb0u6538vwtjc3piym
0b4e540b3ba4        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           12 minutes ago      Up 12 minutes       80/tcp              my_app_php.2.uejgm1a4035iz0bx208mxom9q
06a6011f4407        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           12 minutes ago      Up 12 minutes       80/tcp              my_app_php.3.nb0cbp5jhailiu3ee2bbvkbr7</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora lanzamos un <code>kill</code> sobre el tercer contenedor <code>06a6011f4407</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker kill 06a6011f4407</code></pre>
</div>
</div>
<div class="paragraph">
<p>Tras unos instantes habrá un nuevo contenedor en su puesto</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker ps
CONTAINER ID        IMAGE                             COMMAND             CREATED             STATUS              PORTS               NAMES
847cf3ae0a1c        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           5 seconds ago       Up 4 seconds        80/tcp              my_app_php.3.2khgab4796zhprb17ku0uj68l
ef0248683123        dockersamples/visualizer:stable   "npm start"         14 minutes ago      Up 14 minutes       8080/tcp            my_app_visualizer.1.0kc4fcw7bmvale0i9unh2ph2m
4be7ebee6e84        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           14 minutes ago      Up 14 minutes       80/tcp              my_app_php.1.ueb5qs8kb0u6538vwtjc3piym
0b4e540b3ba4        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           14 minutes ago      Up 14 minutes       80/tcp              my_app_php.2.uejgm1a4035iz0bx208mxom9q</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueescalado-de-la-aplicaci-n"><a class="anchor" href="#trueescalado-de-la-aplicaci-n"></a>7.5. Escalado de la aplicación</h3>
<div class="paragraph">
<p>En Docker Swarm podemos aumentar o disminiur el número de réplicas de un servicio mediante comandos o volviendo a desplegar el stack modificando el número de réplicas.</p>
</div>
<div class="sect3">
<h4 id="trueescalado-mediante-comandos"><a class="anchor" href="#trueescalado-mediante-comandos"></a>7.5.1. Escalado mediante comandos</h4>
<div class="paragraph">
<p>La sintaxis es</p>
</div>
<div class="paragraph">
<p><code>$ docker service scale &lt;SERVICE-ID&gt;=&lt;NUMBER-OF-TASKS&gt;</code></p>
</div>
<div class="paragraph">
<p>Por ejemplo, para que el número de réplicas del servicio <code>php</code> del stack <code>my_app</code> sea 7 ejecutaríamos el comando</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker service scale my_app_php=7
my_app_php scaled to 7
overall progress: 7 out of 7 tasks
1/7: running   [==================================================&gt;]
2/7: running   [==================================================&gt;]
3/7: running   [==================================================&gt;]
4/7: running   [==================================================&gt;]
5/7: running   [==================================================&gt;]
6/7: running   [==================================================&gt;]
7/7: running   [==================================================&gt;]
verify: Service converged


$ docker ps
CONTAINER ID        IMAGE                             COMMAND             CREATED             STATUS              PORTS               NAMES
81d00cc913c9        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           42 seconds ago      Up 43 seconds       80/tcp              my_app_php.7.tjknquh9jkj8bey90pisul2fw
0f9d8ba7b254        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           42 seconds ago      Up 43 seconds       80/tcp              my_app_php.5.daf2ni5cefc22zsky8ez7z58w
226c60af9984        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           42 seconds ago      Up 45 seconds       80/tcp              my_app_php.4.br2nbqhhh9s3x0fwo4d9llgco
e98b5194787b        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           42 seconds ago      Up 42 seconds       80/tcp              my_app_php.6.je2gqb380r3f6hcb6w9sd081q
847cf3ae0a1c        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           11 minutes ago      Up 11 minutes       80/tcp              my_app_php.3.2khgab4796zhprb17ku0uj68l
ef0248683123        dockersamples/visualizer:stable   "npm start"         25 minutes ago      Up 25 minutes       8080/tcp            my_app_visualizer.1.0kc4fcw7bmvale0i9unh2ph2m
4be7ebee6e84        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           25 minutes ago      Up 25 minutes       80/tcp              my_app_php.1.ueb5qs8kb0u6538vwtjc3piym
0b4e540b3ba4        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           25 minutes ago      Up 25 minutes       80/tcp              my_app_php.2.uejgm1a4035iz0bx208mxom9q</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="trueescalado-volviendo-a-desplegar-el-stack"><a class="anchor" href="#trueescalado-volviendo-a-desplegar-el-stack"></a>7.5.2. Escalado volviendo a desplegar el stack</h4>
<div class="paragraph">
<p>Para escalar con la técnica de <em>redespliegue</em>, editar el archivo <code>docker-compose.yml</code> con el nuevo número de réplicas y volver a hacer el despliegue con</p>
</div>
<div class="paragraph">
<p><code>docker stack deploy -c docker-compose.yml my_app</code></p>
</div>
<div class="paragraph">
<p>Por ejemplo, probemos a reducir a 5 el número de réplicas. Con <code>docker stack ps my_app</code> podemos ver los cambios, así como con <code>docker ps</code>, así como desde Visualizer.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker ps
CONTAINER ID        IMAGE                             COMMAND             CREATED             STATUS              PORTS               NAMES
0f9d8ba7b254        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           2 minutes ago       Up 2 minutes        80/tcp              my_app_php.5.daf2ni5cefc22zsky8ez7z58w
226c60af9984        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           2 minutes ago       Up 2 minutes        80/tcp              my_app_php.4.br2nbqhhh9s3x0fwo4d9llgco
847cf3ae0a1c        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           13 minutes ago      Up 13 minutes       80/tcp              my_app_php.3.2khgab4796zhprb17ku0uj68l
ef0248683123        dockersamples/visualizer:stable   "npm start"         27 minutes ago      Up 27 minutes       8080/tcp            my_app_visualizer.1.0kc4fcw7bmvale0i9unh2ph2m
4be7ebee6e84        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           27 minutes ago      Up 27 minutes       80/tcp              my_app_php.1.ueb5qs8kb0u6538vwtjc3piym
0b4e540b3ba4        ualmtorres/phalcon-apache-ubuntu:latest           "/run.sh"           27 minutes ago      Up 27 minutes       80/tcp              my_app_php.2.uejgm1a4035iz0bx208mxom9q</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta operación de actualización del despliegue es la que también se usa para añadir nuevos servicios a un <em>stack</em>. Basta con añadir los nuevos servicios a <code>docker-compose.yml</code> y <em>redesplegar</em> el stack</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect3">
<h4 id="trueapagado-de-la-aplicaci-n-y-del-swarm"><a class="anchor" href="#trueapagado-de-la-aplicaci-n-y-del-swarm"></a>7.5.3. Apagado de la aplicación y del swarm</h4>
<div class="paragraph">
<p>Para eliminar el stack de dos servicios creado para este ejemplo ejecutamos el comando siguiente</p>
</div>
<div class="paragraph">
<p><code>$ docker stack rm my_app</code></p>
</div>
<div class="paragraph">
<p>Esta operación detendrá todos los contendores asociados al stack.</p>
</div>
<div class="paragraph">
<p>Para que nuestro nodo (el nodo <em>manager</em>) deje el <em>swarm</em> ejecutaremos el comando</p>
</div>
<div class="paragraph">
<p><code>$ docker swarm leave --force</code></p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueresumen-de-los-comandos-para-em-swarms-em"><a class="anchor" href="#trueresumen-de-los-comandos-para-em-swarms-em"></a>7.6. Resumen de los comandos para <em>swarms</em></h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker swarm init             Inicialización de swarm y del nodo manager
$ docker stack deploy -c docker-compose.yml &lt;stack&gt; Despliegue de stack
$ docker stack ls               Lista de stacks y cantidad de servicios que tiene
$ docker service ls             Listado de servicios y estado de sus réplicas
$ docker stack ps &lt;stack&gt;       Listado de las tareas del stack
$ docker stack rm &lt;stack&gt;       Eliminación del stack
$ docker swarm leave --force    Salida de un nodo del swarm</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truedocker-machine"><a class="anchor" href="#truedocker-machine"></a>8. Docker machine</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Docker machine es una herramienta que nos permite:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Administrar <em>swarms</em> aprovisiónandolos y añadiéndoles nodos</p>
</li>
<li>
<p>Instalar y ejecutar Docker en los nodos creados</p>
</li>
<li>
<p>Aprovisionar los nodos creados</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Los nodos del <em>swarm</em> pueden ser máquinas virtuales creadas en el host con VirtualBox o con proveedores cloud como Azure, AWS u OpenStack. En este seminario nos centraremos en la creación e inicialización de un <em>swarm</em> en OpenStack. En nuestro caso, Docker machine usará la API de OpenStack encargándose de la creación de los nodos del <em>swarm</em> evitando tener que crear los nodos desde OpenStack.</p>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-archivo-con-variables-de-entorno"><a class="anchor" href="#truecreaci-n-de-archivo-con-variables-de-entorno"></a>8.1. Creación de archivo con variables de entorno</h3>
<div class="paragraph">
<p>Incluiremos las opciones habituales y que están disponibles como variables de entorno. Se incluirán en el archivo los valores de OpenStack relativos a la cuenta de usuario, red, proyecto y demás.</p>
</div>
<div class="paragraph">
<p><code>openrc-mtorres.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export OS_USERNAME=mtorres
export OS_PASSWORD=XXXXXXXXXXXX
export OS_PROJECT_NAME=mtorres
export OS_USER_DOMAIN_NAME=Default
export OS_PROJECT_DOMAIN_NAME=Default
export OS_AUTH_URL=http://www.xxx.yyy.zzz:5000/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
export OS_TENANT_NAME=mtorres</code></pre>
</div>
</div>
<div class="paragraph">
<p>donde <code>www.xxx.yyy.zzz</code> es el nombre DNS o IP que usemos para conectarnos a OpenStack.</p>
</div>
<div class="paragraph">
<p>A continuación, cargaremos las variables de entorno con</p>
</div>
<div class="paragraph">
<p><code>source openrc-mtorres.sh</code></p>
</div>
</div>
<div class="sect2">
<h3 id="truecreaci-n-de-los-nodos-del-em-swarm-em"><a class="anchor" href="#truecreaci-n-de-los-nodos-del-em-swarm-em"></a>8.2. Creación de los nodos del <em>swarm</em></h3>
<div class="paragraph">
<p>Para crear los nodos del <em>swarm</em> en OpenStack con Docker machine tendremos que pasar una serie de valores relativos al sabor, nombre de imagen, red, nombre de usuario de las instancias, claves ssh, y demás.</p>
</div>
<div class="paragraph">
<p>Desde una máquina que esté en la red de la UAL creamos una máquina con Docker con este comando (no vale por VPN porque actualmente el puerto 5000 que se usa para la autenticación con OpenStack no está abierto en VPN):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker-machine create -d openstack \
--openstack-flavor-name small \
--openstack-image-name "Ubuntu 16.04 LTS" \
--openstack-domain-name default \
--openstack-net-name mtorres-net \
--openstack-floatingip-pool ext-net \
--openstack-ssh-user ubuntu \
--openstack-sec-groups default \
--openstack-keypair-name mtorres_ual \
--openstack-private-key-file ~/.ssh/id_rsa \
nodo1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto comenzará a crear una instancia con los parámetros indicados en nuestro proyecto OpenStack. Tras unos instantes, nos devolverá esta información relativa a la creación del <code>nodo1</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">Running pre-create checks...
Creating machine...
(nodo1) Creating machine...
Waiting for machine to be running, this may take a few minutes...
Detecting operating system of created instance...
Waiting for SSH to be available...
Detecting the provisioner...
Provisioning with ubuntu(systemd)...
Installing Docker...
Copying certs to the local machine directory...
Copying certs to the remote machine...
Setting Docker configuration on the remote daemon...
Checking connection to Docker...
Docker is up and running!
To see how to connect your Docker Client to the Docker Engine running on this virtual machine, run: docker-machine env nodo1</code></pre>
</div>
</div>
<div class="paragraph">
<p>Repetimos el comando para crear otro nodo en nuestro proyecto al que denominaremos <code>nodo2</code>.</p>
</div>
<div class="paragraph">
<p>Para listar las dos máquinas creadas con Docker machine ejecutaremos el comando siguiente.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker-machine ls
NAME    ACTIVE   DRIVER      STATE     URL                         SWARM   DOCKER        ERRORS
nodo1   -        openstack   Running   tcp://192.168.66.211:2376           v18.05.0-ce
nodo2   -        openstack   Running   tcp://192.168.66.235:2376           v18.05.0-ce</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para acceder a las máquinas creadas y ver que aún no tienen contenedores  creados debemos cargar las variables de entorno de la que vayamos a usar (p.e. <code>nodo1</code>).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ eval $(docker-machine env nodo1)
$ docker ps
CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</code></pre>
</div>
</div>
<div class="paragraph">
<p>Para crear el <em>swarm</em> haremos que el nodo 1 sea el <em>manager</em> y el nodo 2 sea el <em>worker</em>.</p>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-nodo-em-manager-em"><a class="anchor" href="#truecreaci-n-del-nodo-em-manager-em"></a>8.2.1. Creación del nodo <em>manager</em></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker-machine  ssh nodo1 "sudo docker swarm init --advertise-addr 192.168.66.211"
Swarm initialized: current node (y0831vf8yj3vu120jj3zp8c6k) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-1j411qkevgcza9uunune32q4p6p4xylyz944uozow0l7shr66t-7ujr8f9i9lti19rz9oqkjh89n 192.168.66.211:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.</code></pre>
</div>
</div>
<div class="paragraph">
<p>Anotaremos el token para poder añadir nodos al swarm.</p>
</div>
</div>
<div class="sect3">
<h4 id="truecreaci-n-del-nodo-em-worker-em"><a class="anchor" href="#truecreaci-n-del-nodo-em-worker-em"></a>8.2.2. Creación del nodo <em>worker</em></h4>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker-machine ssh nodo2 "sudo docker swarm join --token SWMTKN-1-1j411qkevgcza9uunune32q4p6p4xylyz944uozow0l7shr66t-7ujr8f9i9lti19rz9oqkjh89n 192.168.66.211:2377"
This node joined a swarm as a worker.</code></pre>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truecomprobaci-n-del-em-swarm-em-creado"><a class="anchor" href="#truecomprobaci-n-del-em-swarm-em-creado"></a>8.3. Comprobación del <em>swarm</em> creado</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">$ docker-machine ssh nodo1 "sudo docker node ls"
ID                            HOSTNAME            STATUS              AVAILABILITY        MANAGER STATUS      ENGINE VERSION
y0831vf8yj3vu120jj3zp8c6k *   nodo1               Ready               Active              Leader              18.05.0-ce
zgc0e50822qabzlfceclrso6c     nodo2               Ready               Active                                  18.05.0-ce</code></pre>
</div>
</div>
</div>
<div class="sect2">
<h3 id="truedespliegue-de-la-aplicaci-n-en-los-nodos"><a class="anchor" href="#truedespliegue-de-la-aplicaci-n-en-los-nodos"></a>8.4. Despliegue de la aplicación en los nodos</h3>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Abrir sesiones SSH en cada nodo del <em>swarm</em> para añadir el usuario <code>ubuntu</code> al grupo <code>docker</code> con <code>sudo usermod -a -G docker ubuntu</code> y añadir los directorios que usen como punto de montaje de los volúmenes (Probar a hacer esto con docker-machine)</p>
</li>
<li>
<p>Hacer despliegue desde el nodo manager</p>
</li>
</ol>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-yaml" data-lang="yaml">version: '3'
services:
  php:
    image: ualmtorres/phalcon-apache-ubuntu
    ports:
      - "80:80"
    volumes:
      - ./html:/var/www/html
    deploy:
      replicas: 4
      resources:
        limits:
          cpus: "0.1"
          memory: 50M
      restart_policy:
        condition: on-failure
    networks:
      - webnet
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints: [node.role == manager]
    networks:
      - webnet
networks:
  webnet:</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/VisualizerSwarm.png" alt="VisualizerSwarm.png">
</div>
<div class="title">Figure 14. Cluster de dos nodos con 4 réplicas del servicio <code>php</code></div>
</div>
</div>
<div class="sect2">
<h3 id="truedesalojo-de-un-nodo"><a class="anchor" href="#truedesalojo-de-un-nodo"></a>8.5. Desalojo de un nodo</h3>
<div class="paragraph">
<p>Para finalizar vamos a ver cómo desalojar un nodo (p.e. debido a una operación de mantenimiento en uno de los servidores del <em>swarm</em>).</p>
</div>
<div class="paragraph">
<p>Por ejemplo, veamos como desalojar el nodo <em>worker</em> <code>nodo2</code>.</p>
</div>
<div class="paragraph">
<p>Haremos esta operación directamente desde el nodo <em>manager</em>, aunque se podría hacer desde otro nodo, o incluso de forma remota con <code>docker-machine</code>. Tras iniciar sesión en <code>nodo1</code> primero veremos el estado de los servicios y los nodos en los que se están ejecutando.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker service ps my_app_php
ID                  NAME                IMAGE                     NODE                DESIRED STATE       CURRENT STATE         ERROR                              PORTS
phqzhyvrn2cs        my_app_php.1        ualmtorres/phalcon-apache-ubuntu:latest   nodo1               Running             Running 5 days ago
7tcammel94a8        my_app_php.2        ualmtorres/phalcon-apache-ubuntu:latest   nodo2               Running             Running 5 days ago
5y969fj92o5g        my_app_php.3        ualmtorres/phalcon-apache-ubuntu:latest   nodo1               Running             Running 5 days ago
m7cjujgg08bw        my_app_php.4        ualmtorres/phalcon-apache-ubuntu:latest   nodo2               Running             Running 5 days ago</code></pre>
</div>
</div>
<div class="paragraph">
<p>haremos la operación <code>drain</code> para desalojar el <code>nodo2</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker node update --availability drain nodo2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Al comprobar el estado del servicio veremos que ahora todos los contenedores han pasado a <code>nodo1</code> manteniendo el número de réplicas que tuviésemos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker service ps my_app_php
ID                  NAME                IMAGE                     NODE                DESIRED STATE       CURRENT STATE            ERROR                              PORTS
phqzhyvrn2cs        my_app_php.1        ualmtorres/phalcon-apache-ubuntu:latest   nodo1               Running             Running 5 days ago
zqb89jdjraz7        my_app_php.2        ualmtorres/phalcon-apache-ubuntu:latest   nodo1               Running             Starting 2 seconds ago
5y969fj92o5g        my_app_php.3        ualmtorres/phalcon-apache-ubuntu:latest   nodo1               Running             Running 5 days ago
6q9955ce8fdw        my_app_php.4        ualmtorres/phalcon-apache-ubuntu:latest   nodo1               Running             Starting 3 seconds ago</code></pre>
</div>
</div>
<div class="paragraph">
<p>Con Visualizer podemos ver de forma más gráfica cómo se ha desalojado el nodo</p>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/VisualizerDrain.png" alt="VisualizerDrain.png">
</div>
</div>
<div class="paragraph">
<p>Una vez finalizada la operación de mantenimiento volveríamos a poner el nodo como activo (<code>--availability active</code>)</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>$ docker node update --availability active nodo2</code></pre>
</div>
</div>
<div class="paragraph">
<p>El nodo ahora podrá volver a recibir nuevas tareas</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="truecreaci-n-de-clusters-kubernetes-con-rancher-2-0"><a class="anchor" href="#truecreaci-n-de-clusters-kubernetes-con-rancher-2-0"></a>9. Creación de clusters Kubernetes con Rancher 2.0</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Kubernetes se ha convertido en el estándar para orquestación de contenedores. La mayoría de los proveedores cloud lo ofrece con infraestructura estándar.</p>
</div>
<div class="paragraph">
<p><a href="https://rancher.com/">Rancher 2.0</a> nos ofrece una plataforma on-premise para hacer despliegues de clusters de Kubernetes en proveedores cloud como Amazon EKS, Google Container Engine, Azure Container Service,  Amazon EC2, Microsoft Azure, Digital Ocean, OpenStack, RackSpace y demás,</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p><a href="https://rancher.com/rancher-os/">RancherOS</a> es una distribución de Linux rápida y ligera optimizada para usarse con contenedores. Incluye el software mínimo para ejecutar Docker.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Para ejecutar Rancher 2.0 con una carpeta local para el almacenamiento de los datos de Rancher ejecutaríamos el comando siguiente</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">docker run -d --restart=unless-stopped \
-p 9000:9000 \
-v `pwd`/rancher16_data:/var/lib/mysql \
rancher/rancher <i class="conum" data-value="1"></i><b>(1)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>rancher/rancher</code> es el nombre de la imagen de Rancher 2.0, mientras que <code>rancher/server</code> es el nombre de la imagen de Rancher 1.6</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/Rancher20.png" alt="Rancher20.png">
</div>
<div class="title">Figure 15. Elección de OpenStack como infraestrucutra para despligue de un cluster de contenedores</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="trueotras-cosas-interesantes"><a class="anchor" href="#trueotras-cosas-interesantes"></a>10. Otras cosas interesantes</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="truemicroservicios-y-contenedores"><a class="anchor" href="#truemicroservicios-y-contenedores"></a>10.1. Microservicios y contenedores</h3>
<div class="paragraph">
<p>Con microservicios:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Establecemos un contrato, normalmente mediante una API REST, versionada para no romper funcionalidad a usuarios anteriores</p>
</li>
<li>
<p>Ocupan un tamaño reducido y suelen realizar una tarea muy concreta</p>
<div class="ulist">
<ul>
<li>
<p>Autenticación,</p>
</li>
<li>
<p>API REST. Toda la API vs cada endpoint</p>
</li>
<li>
<p>Estadísticas consumo de recursos</p>
</li>
<li>
<p>Exportar salida a central de logs</p>
</li>
<li>
<p>&#8230;&#8203;</p>
</li>
</ul>
</div>
</li>
<li>
<p>Dockerizar con cabeza</p>
<div class="ulist">
<ul>
<li>
<p>Comenzamos pasando todo nuestro sistema o MV a un contenedor Docker. Con sólo eso ya conseguimos ejecutar nuestra sistema en distintas máquinas con distintos SO y configuraciones.</p>
</li>
<li>
<p>No intentar pasar de una vez de aplicación monlítica a microservicios diminutos</p>
</li>
</ul>
</div>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/KeepCalmAndUseDocker.png" alt="KeepCalmAndUseDocker.png" width="100%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueel-ecosistema-docker"><a class="anchor" href="#trueel-ecosistema-docker"></a>10.2. El ecosistema Docker</h3>
<div class="imageblock">
<div class="content">
<img src="./images/DockerEcosystem.png" alt="DockerEcosystem.png" width="100%">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueinstalar-un-registro-de-im-genes-propio"><a class="anchor" href="#trueinstalar-un-registro-de-im-genes-propio"></a>10.3. Instalar un registro de imágenes propio</h3>
<div class="paragraph">
<p>Es posible tener un registro propio para imágenes por cuestiones de seguridad y confidencialidad. Veamos cómo crear un registro propio mediante contenedores (uno para el registro en sí y otro cono Web UI).</p>
</div>
<div class="paragraph">
<p>El ejemplo será obtener una imagen Alpine de Docker Hub y subirla a nuestro propio registro</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">// En el servidor (p.e. 192.168.65.103)
$ docker run -d -p 5000:5000 --restart always --name registry registry:2
$ docker run \
  -d \
  -e ENV_DOCKER_REGISTRY_HOST=192.168.65.103 \
  -e ENV_DOCKER_REGISTRY_PORT=5000 \
  -p 8080:80 \
  konradkleine/docker-registry-frontend:v2

// En nuestro equipo
$ docker pull alpine <i class="conum" data-value="1"></i><b>(1)</b>
$ docker image list | grep alpine <i class="conum" data-value="2"></i><b>(2)</b>
$ docker tag 3e640a41799a 192.168.65.103:5000/alpine <i class="conum" data-value="3"></i><b>(3)</b>
$ docker push 192.168.65.103:5000/alpine <i class="conum" data-value="4"></i><b>(4)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Descargar una imagen de prueba de Alpine al registro local</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Obtener el identificador de la imagen Alpine descargada (p.e. <code>3e640a41799a</code>)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>La imagen se etiqueta añadiéndole como prefijo host:puerto de nuestro registro</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Subida de la imagen al registro</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="./images/RegistroPropio.png" alt="RegistroPropio.png">
</div>
</div>
</div>
<div class="sect2">
<h3 id="trueconexi-n-a-daemons-docker-remotos"><a class="anchor" href="#trueconexi-n-a-daemons-docker-remotos"></a>10.4. Conexión a daemons Docker remotos</h3>
<div class="paragraph">
<p>Util para conectarnos desde nuestro equipo al Docker de producción o al de  pruebas</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Crear en local un archivo de variables de entorno (p.e. <code>DockerProyectoBrainstorm.sh</code>)</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code class="language-bash" data-lang="bash">export DOCKER_TLS_VERIFY=1
export DOCKER_CERT_PATH="&lt;ruta completa de certificado&gt;"
export DOCKER_HOST="tcp://&lt;IP o nombre DNS&gt;:443"</code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p>Después, <code>source DockerProyectoBrainstorm.sh</code> y ¡¡Estamos conectados!!</p>
</li>
<li>
<p>Si la conexión fuera abierta, indicaríamos <code>export DOCKER_TLS_VERIFY=0</code>.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="trueuso-de-haproxy"><a class="anchor" href="#trueuso-de-haproxy"></a>10.5. Uso de HAProxy</h3>
<div class="listingblock">
<div class="content">
<pre class="highlight"><code>docker-compose.yml
version: '3'
services:
  php:
    image: ualmtorres/phalcon-apache-ubuntu
    ports:
      - "80"
    environment:
     - SERVICE_PORTS=80 <i class="conum" data-value="1"></i><b>(1)</b>
    volumes:
      - ./html:/var/www/html
    deploy:
      replicas: 6
      resources:
        limits:
          cpus: "0.1"
          memory: 50M
      restart_policy:
        condition: on-failure
    networks:
      - webnet
  visualizer:
    image: dockersamples/visualizer:stable
    ports:
      - "8080:8080"
    volumes:
      - "/var/run/docker.sock:/var/run/docker.sock"
    deploy:
      placement:
        constraints: [node.role == manager]
    networks:
      - webnet
  proxy: <i class="conum" data-value="2"></i><b>(2)</b>
    image: dockercloud/haproxy
    depends_on:
      - php <i class="conum" data-value="3"></i><b>(3)</b>
    environment:
      - BALANCE=leastconn <i class="conum" data-value="4"></i><b>(4)</b>
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
    ports:
      - 80:80
    networks:
      - webnet
    deploy:
      placement:
        constraints: [node.role == manager]
networks:
  webnet:</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Cambio en la configuración de puertos para usar HAProxy</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Servicio <code>proxy</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>No crear el servicio <code>proxy</code> hasta que no se haya creado el <code>php</code></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Usa la política de balanceo <em>least connections</em> en lugar de la <em>round robin</em> predeterminada</td>
</tr>
</table>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2020-04-16 07:10:31 CEST
</div>
</div>
</body>
</html>